define(function(){function t(t){this._options=this._options||{},$.extend(this._options,p),$.extend(this._options,t),this.init()}function e(t,e){for(var a=t.data,n=t.name||"",o='<td data-name="'+n+'"><div class="select2-ul select2-ul-mask"><ul data-index="'+(t.index||0)+'">',i=0;i<a.length;i++)o+='<li data-id="'+a[i][0]+'">'+e(a[i])+"</li>";return o+="</ul></div></td>"}function a(t){switch(t.type){case"orientationchange":this.refresh();break;case"touchmove":t.preventDefault()}}function n(t,e){if(!d){var a=$("li",t).length;if(2>a)return;if(e.preventDefault(),d=t,v=Math.floor($(t.parentNode).height()/(2*k)),u=-((a-v-1)*k),_=v*k,m=new Date,event.targetTouches&&1==event.targetTouches.length){var n=event.targetTouches[0];w.starttop=n.pageY}f=r(d),$(document).on("touchmove",o).on("touchend",this.onEnd)}}function o(t){if(t.stopPropagation(),t.preventDefault(),1==event.targetTouches.length){var e=event.targetTouches[0];w.movetop=e.pageY,g=r(d),g=parseFloat(g,10),l(d,w.movetop-(w.lasttop||w.starttop)+g,0),w.lasttop=w.movetop}}function i(t,e,a){return Math.max(e,Math.min(t,a))}function s(t){var e,a,n=new Date-m,s=this,p=s._options,h=r(d),v=h;300>n?(e=Math.abs(Math.abs(h)-Math.abs(f))/n,a=e*e/.0013,n=8*Math.sqrt(Math.abs(e*e*.8))/10,w.movetop<w.starttop&&(a=-a),v+=a):n=.01,v=i(Math.round(parseFloat(v,10)/k)*k,u,_);var g=d;l(d,v,n,function(){var t=c.call(s,g,!1);t!==!1&&p.changeFn&&p.changeFn(t)}),w.lasttop=0,d=null,$(document).off("touchmove",o).off("touchend",this.onEnd)}function c(t,e){var a=$(t).attr("data-top")||0,n=this,o=n._options,i=Math.abs(a/k);a>0?i=Math.abs(i-o.overIndex):i+=o.overIndex,i=0>i?0:i;var s=$("li",t)[i],c=$(s).closest("td");if(e===!1){if(c.data("choose")===s)return!1;c.data("choose",s)}return c=c.attr("data-name"),[c,s]}function r(t){var e=$(d).attr("data-top");return e&&"NaN"!=e?parseFloat(e):0}function l(t,e,a,n){var o=t.style,s=i(e,u,_);o[x+"Transition"]="all "+(a?a.toFixed(3):0)+"s ease-out",o[x+"Transform"]="translate3d(0,"+s+"px,0)",function(t){clearTimeout(b),b=setTimeout(function(){$("li",t).removeClass("actives").eq(-s/35+h).addClass("actives"),n&&n()},1e3*(a||0))}($(d).attr("data-top",s))}var p={mask:!0,width:"100%",larger:!0,title:"选择",okTxt:"确定",className:"",cancelTxt:"取消",changeFn:function(t){},cancelFn:function(){},itemPrintFn:function(t){return'<span data-id="'+t[0]+'">'+t[1]+"</span>"}};t.prototype.init=function(){var t=this,e=t._options;t.eventHand=$.proxy(a,t),t.Onstart=$.proxy(n,t),t.onEnd=$.proxy(s,t),e._container=$(document.body),e._cIsBody=!0,e._mask=e.mask?$('<div class="ui-select2-bg"></div>').appendTo(e._container):null,e._isOpen=!1,e.maskClose&&e._mask.on("click",function(){t.close()});var o='<a class="select2-cancel" title="'+e.cancelTxt+'">'+e.cancelTxt+"</a>",i='<a class="select2-ok" title="'+e.okTxt+'">'+e.okTxt+"</a>",c="<h3>"+e.title+"</h3>",r='<div class="ui-select2 '+e.className+'"><div class="ui-select2-c '+("top"===e.btnPosition?"ui-select2-c-top":"")+'">'+("top"!==e.btnPosition?c:'<div class="select2-title-content">'+o+c+i+"</div>")+'<div class="select2-content clearfix"><table '+(e.larger?'class="select2-larger"':"")+"></table><p></p></div>"+("top"!==e.btnPosition?i+o:"")+"</div></div>";e._wrap=$(r).appendTo(e._container),e.table=$("table",e._wrap),e.overIndex=h=e.larger?2:1,t.create(e.data),e._wrap.css({width:e.width,height:"auto"}),$(".select2-cancel",e._wrap).on("click",function(){t.close()}),$(".select2-ok",e._wrap).on("click",function(){if(e.selectFn){var a=[];$("table td ul",e._wrap).each(function(){a.push(t.getVal(this))}),e.selectFn(a)!==!1&&t.close()}else t.close()}),$(".select2-content li",e._wrap).on("click",function(t){}),e._mask.on("click",function(){e.maskClickClose&&t.close()}),e._wrap.on("click",t.eventHand)},t.prototype.title=function(t){var e=$(".ui-select2-c>h3",this._options._wrap);return t&&e.html(t),e},t.prototype.create=function(t){var a=this,n=a._options;if(t&&t.length>0){for(var o="<tr>",i=0;i<t.length;i++)o+=e.call(a,t[i],n.itemPrintFn);o+="</tr>";var s=$(o).appendTo(n.table);$(".select2-ul ul",s).on("touchstart",function(t){a.Onstart(this,t)}).each(function(){a.updateIndex(this,$(this).attr("data-index"))})}},t.prototype.getVal=function(t){var e=this._options,a="string"==typeof t?$('td[data-name="'+t+'"] ul',e.table):t;return c.call(this,a)},t.prototype.updateIndex=function(t,e){var a=this,n=a._options,o="string"==typeof t?$('td[data-name="'+t+'"] ul'):$(t),i=$('li[data-id="'+e+'"]',o),s=i.index(),c=(n.overIndex-s)*k;if(!i[0]){var r=o.attr("data-top");return r=r?-r/35+n.overIndex:n.overIndex,void $("li",o).removeClass("actives").eq(r).addClass("actives")}o[0].style[x+"Transition"]="all 0s ease-out",o[0].style[x+"Transform"]="translate3d(0,"+c+"px,0)",o.attr("data-top",c),$("li",o).removeClass("actives").eq(-c/35+n.overIndex).addClass("actives")},t.prototype.updateSelect=function(t){var a=this,n=a._options;if(t.name){var o=$('td[data-name="'+t.name+'"]',n.table);if(o[0]){var i=$(e.call(a,t,n.itemPrintFn));o.replaceWith(i),$(".select2-ul ul",i).on("touchstart",function(t){a.Onstart(this,t)}),a.updateIndex($("ul",i),t.index)}}};var d,u,h,f,v,m,_=0,k=35,g=0,w={},x="",y=document.createElement("div");$.each(["webkit","Moz","O","ms"],function(t,e){return void 0!==y.style[e+"Transform"]?(x=e,!1):void 0});var b;t.prototype.calculate=function(){var t,e=this,a=e._options,n=($(window),document.body),o={},i=a._cIsBody,s=Math.round;return a.mask&&(o.mask=i?{width:"100%",height:Math.max(n.scrollHeight,n.clientHeight)-1}:{width:"100%",height:"100%"}),t=a._wrap.offset(),o.wrap={left:"50%",marginLeft:-s(t.width/2)+"px"},o},t.prototype.refresh=function(){var t,e,a=this,n=a._options;return n._isOpenRefresh||(e=function(){t=a.calculate(),t.mask&&n._mask.css(t.mask),n._wrap.css(t.wrap)},$.os&&$.os.ios&&document.activeElement&&/input|textarea|select/i.test(document.activeElement.tagName)?(document.body.scrollLeft=0,setTimeout(e,200)):e()),a},t.prototype.open=function(){var t=this._options,e=this;t._wrap.css("display","block"),t._mask&&t._mask.css("display","block"),t._isOpenRefresh=!1,e.refresh(),t._mask.animate({opacity:.8},300),t._wrap.animate({bottom:0},300,function(){t._isOpen=!0}),$(window).on("orientationchange touchmove click",e.eventHand)},t.prototype.close=function(t){var e=this._options;if(e._isOpen===!1)return this;if(!e.cancelFn||e.cancelFn()!==!1)return e._mask.animate({opacity:0},200),e._wrap.animate({bottom:-260},200,function(){e._wrap.css("display","none"),e._mask&&e._mask.css("display","none"),e._isOpen=!1,e._isOpenRefresh=!1,t&&t()}),$(window).off("orientationchange touchmove click",this.eventHand),this},t.prototype.destroy=function(){var t=this._options,e=this.eventHand;$(window).off("orientationchange",e),$(document).off("touchmove",e),t._wrap.off("click",e).remove(),t._mask&&t._mask.off("click",e).remove()},$.Select=function(e){return new t(e)}});